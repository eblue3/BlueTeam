1, 0x10001074
||
==>
.text:1000D02E                       ; =============== S U B R O U T I N E =======================================
.text:1000D02E
.text:1000D02E
.text:1000D02E                       ; BOOL __stdcall DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)
.text:1000D02E                       _DllMain@12 proc near                   ; CODE XREF: DllEntryPoint+4B↓p
.text:1000D02E                                                               ; DATA XREF: sub_100110FF+2D↓o
.text:1000D02E
.text:1000D02E                       hinstDLL= dword ptr  4
.text:1000D02E                       fdwReason= dword ptr  8
.text:1000D02E                       lpvReserved= dword ptr  0Ch
.text:1000D02E
.text:1000D02E 000 8B 44 24 08               mov     eax, [esp+fdwReason]
--- ---
2, Library: WS2_32
Address: 00000000100163CC
=>  The import for gethostbyname is found at 0x100163CC in the .idata section
--- ---
3, 9: p (type?), 9: r(type?)
Total: 18
||
==> Total: 9, by 5 functions
--- ---
4, pics.praticalmalwareanalysis.com
=> A DNS request for pics.practicalmalwareanalysis.com will be made by the
malware if the call to gethostbyname at 0x10001757 succeeds
--- ---
5,
.text:10001656     var_675         = byte ptr -675h
.text:10001656     var_674         = dword ptr -674h
.text:10001656     hModule         = dword ptr -670h
.text:10001656     timeout         = timeval ptr -66Ch
.text:10001656     name            = sockaddr ptr -664h
.text:10001656     var_654         = word ptr -654h
.text:10001656     in              = in_addr ptr -650h
.text:10001656     Str1            = byte ptr -644h
.text:10001656     var_640         = byte ptr -640h
.text:10001656     CommandLine     = byte ptr -63Fh
.text:10001656     Str             = byte ptr -63Dh
.text:10001656     var_638         = byte ptr -638h
.text:10001656     var_637         = byte ptr -637h
.text:10001656     var_544         = byte ptr -544h
.text:10001656     var_50C         = dword ptr -50Ch
.text:10001656     var_500         = byte ptr -500h
.text:10001656     Buf2            = byte ptr -4FCh
.text:10001656     readfds         = fd_set ptr -4BCh
.text:10001656     buf             = byte ptr -3B8h
.text:10001656     var_3B0         = dword ptr -3B0h
.text:10001656     var_1A4         = dword ptr -1A4h
.text:10001656     var_194         = dword ptr -194h
.text:10001656     WSAData         = WSAData ptr -190h
.text:10001656     lpThreadParameter= dword ptr  4
=> 24
||
==> IDA Pro has recognized 23 local variables for the function at 0x10001656
--- ---
6, 9:
.text:1000165C 678                 push    ebx
.text:1000165D 67C                 push    ebp
.text:1000165E 680                 push    esi
.text:1000165F 684                 push    edi
...
.text:10001682 688                 push    3A98h           ; dwMilliseconds
...
.text:1000169E 688                 push    eax             ; lpWSAData
.text:1000169F 68C                 push    202h            ; wVersionRequested
...
.text:100016AE 688                 push    eax
.text:100016AF 68C                 push    offset Format   ; "WSAStartup() error: %d\n"
||
==> IDA Pro has recognized one parameter for the function at 0x10001656
.text:10001656     lpThreadParameter= dword ptr  4
--- ---
7, xdoors_d:10095B34	\\cmd.exe /c
=> The string \cmd.exe /c is located at 0x10095B34
--- ---
|
=> JUST DOUBLE CLICK ON THE "sub_1000FF58" => GRAPH VIEW => SHOW PROXIMITY BROWSER
|
8,
xdoors_d:10095B20     ; char aCommandExeC[]
xdoors_d:10095B20     aCommandExeC    db '\command.exe /c ',0 ; DATA XREF: sub_1000FF58:loc_100101D7↑o
xdoors_d:10095B31                     align 4
xdoors_d:10095B34     aCmdExeC        db '\cmd.exe /c ',0     ; DATA XREF: sub_1000FF58+278↑o
xdoors_d:10095B41                     align 4
||
==> That area of code appears to be creating a remote shell session for the attacker.
--- ---
9,
.text:10001678 688                 mov     dword_1008E5C4, eax
...
.text:10007320 218                 cmp     dword_1008E5C4, edi ; Compare Two Operands
...
.text:100101C8 16D0                cmp     dword_1008E5C4, ebx ; Compare Two Operands
||
==> The OS version is stored in the global variable dword_1008E5C4.
--- ---
10, ~
||
==> The registry values located at HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\WorkTime
and WorkTimes are queried and sent over the remote shell connection
--- ---
11, "Ring API - List Functions
In this section we will learn about the list functions provided by the Ring API to create new lists and manipulate the list items."
...
||
==> The PSLIST export sends a process listing across the network or finds a
particular process name in the listing and gets information about it.
--- ---
12, ~
||
==> GetSystemDefaultLangID, send, and sprintf are API calls made from
sub_10004E79. This function could be renamed to something useful
like GetSystemLanguage
--- ---
13, 1?
~
||
==> DllMain calls strncpy, strnicmp, CreateThread, and strlen directly. At a depth
of 2, it calls a variety of API calls, including Sleep, WinExec, gethostbyname,
and many other networking function calls
--- ---
14, imul    eax, 3E8h
||
==> The malware will sleep for 30 seconds
--- ---
15,
,text:100016FB 688 6A 06                     push    6                       ; protocol
.text:100016FD 68C 6A 01                     push    1                       ; type
.text:100016FF 690 6A 02                     push    2                       ; af
=> The arguments are 6, 1, and 2
--- ---
16, ~
||
==> These arguments correspond to three symbolic constants: IPPROTO_TCP,
SOCK_STREAM, and AF_INET
--- ---
17, ~
||
==> The in instruction is used for virtual machine detection at 0x100061DB,
and the 0x564D5868h corresponds to the VMXh string. Using the crossreference, we see the string Found Virtual Machine in the caller function
||
==>
Search => Sequence of Byes => "ED" (Opcode for "in")
+ Find all Occurrences
=>
.text:100061DB	sub_10006196	in      eax, dx
--- ---
18, List of defined variable set with character?
.data:1001D988 2D                            db  2Dh ; -
.data:1001D989 31                            db  31h ; 1
.data:1001D98A 3A                            db  3Ah ; :
.data:1001D98B 3A                            db  3Ah ; :
.data:1001D98C 27                            db  27h ; '
.data:1001D98D 75                            db  75h ; u
.data:1001D98E 3C                            db  3Ch ; <
.data:1001D98F 26                            db  26h ; &
.data:1001D990 75                            db  75h ; u
.data:1001D991 21                            db  21h ; !
=> Random data appears to exist at 0x1001D988
--- ---
19,
Python>os.system("python3 Lab05-01.py")
0x2331
||
==> If you run Lab05-01.py, the random data is unobfuscated to reveal a string
--- ---
20,
Python>os.system("python3 Lab05-01.py")
0x2331
--- ---
